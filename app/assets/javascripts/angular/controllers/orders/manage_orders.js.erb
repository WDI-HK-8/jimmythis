app.controller('OrdersIndexCtrl', ['$scope','$auth','$http','$location', function($scope, $auth, $http, $location){
  $scope.message = "Manage Orders";

  var url = "<%= ENV['URL'] %>" || "http://localhost:3000";
  $auth.validateUser()
    .then(function(resp) {
      $scope.loggedIn = true;
      $http.get(url + '/users/' + resp.id + '/orders').success(function(response) {
        console.log(response)
        if(response.length > 0) {
          $scope.orders = response;
          $scope.orders.forEach(function(order) {
            if(order.user.id == resp.id) {
              $http.get(url + '/users/' + order.service.user).success(function(seller) {
                order.seller = seller.name;
                order.sellerId = seller.id;
                order.contact = order.service.user;
                $scope.client = false;
              });
            } else {
              order.client = order.user.name;
              order.clientId = order.user.id;
              order.contact = order.user.id;
              $scope.client = true;
            }
          });
        } else {
          $scope.noOrders = true
        }
      });
    })
    .catch(function(resp) {
      console.log(resp)
      $location.path('/')
    });
  
}]);