app.controller('OrdersIndexCtrl', ['$scope','$auth','$http','$location', function($scope, $auth, $http, $location){
  $scope.message = "Manage Orders";

  var url = "<%= ENV['URL'] %>" || "http://localhost:3000";
  $auth.validateUser()
    .then(function(resp) {
      $scope.loggedIn = true;
      $http.get(url + '/users/' + resp.id + '/orders').success(function(response) {
        console.log(response)
        if(response.length > 0) {
          $scope.orders = response;
          $scope.orders.forEach(function(order) {
            if(order.user.id == resp.id) {
              order.seller = order.user.name;
              order.sellerId = 'You';
              $http.get(url + '/users/' + order.service.user).success(function(client) {
                order.client = client.name;
                order.clientId = client.id;
                order.contact = order.service.user;
              });
            } else {
              order.seller = 'You';
              order.client = order.user.name;
              order.sellerId = resp.id
              order.clientId = order.user.id;
              order.contact = order.user.id;
            }
          });
        } else {
          $scope.noOrders = true
        }
      });
    })
    .catch(function(resp) {
      console.log(resp)
      $location.path('/')
    });
  
}]);